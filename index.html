<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Shuttle - Liberia Airport Shuttle</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&family=Oswald:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- VERIFICACI√ìN DE SESI√ìN -->
    <script>
        (async function checkAuth() {
            try {
                const response = await fetch('api/check_session.php');
                const data = await response.json();
                if (!data.authenticated) {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Error verificando sesi√≥n:', error);
                window.location.href = 'login.html';
            }
        })();
    </script>

    <!-- CONEXI√ìN AL MEN√ö -->
    <script src="menu.js" defer></script>

    <style>
        :root {
            --primary: #002a3f;
            --secondary: #ffffff;
            --accent: #ed4441;
            --bg-light: #f1f5f9;
            --whatsapp: #25d366;
            --email-btn: #3b82f6;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-light);
            color: #333;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            font-size: 15px;
        }

        h1,
        h2,
        h3,
        .title-font {
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
        }

        .main-container {
            width: 100%;
            padding: 18px 18px 32px;
            max-width: none;
            margin: 0;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 12px;
            }
        }

        @media (min-width: 768px) {
            .main-container {
                padding: 30px;
            }
        }

        @media (max-width: 640px) {
            body {
                font-size: 14px;
            }

            h2 {
                font-size: 1.25rem !important;
            }

            .main-container {
                padding: 8px;
            }
        }

        /* Font sizes responsivos para t√≠tulos */
        @media (max-width: 768px) {
            h2 {
                font-size: 1.5rem !important;
            }
        }

        /* Responsive para botones del modal */
        @media (max-width: 768px) {

            #btn-save,
            .px-6 {
                padding: 0.5rem 1rem !important;
            }
        }

        @media (max-width: 640px) {

            #btn-save,
            .px-6.py-2 {
                padding: 0.75rem !important;
                font-size: 12px !important;
                width: 100%;
            }

            .p-4.border-t {
                flex-direction: column;
                gap: 0.5rem !important;
            }
        }

        /* --- ESTILO DE TABLA LINEAL --- */
        .table-wrapper {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0;
            width: 100%;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            background-color: #f8fafc;
            padding: 16px 20px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            color: #64748b;
            border-bottom: 2px solid #e2e8f0;
            text-align: left;
            letter-spacing: 1px;
        }

        tbody tr {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        @media (min-width: 768px) {
            td {
                padding: 16px 20px;
                font-size: 15px;
                color: #334155;
                vertical-align: middle;
            }
        }

        @media (max-width: 768px) {
            table {
                font-size: 13px;
            }

            thead th {
                padding: 12px 10px;
                font-size: 10px;
            }

            td {
                padding: 12px 10px;
                font-size: 13px;
            }

            .client-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
                margin-right: 8px;
            }
        }

        @media (max-width: 640px) {
            .table-wrapper {
                border: none;
                background: transparent;
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
                width: 100%;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                margin-bottom: 16px;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 16px;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }

            td {
                border: none;
                position: relative;
                padding-left: 0 !important;
                text-align: left;
                font-size: 14px;
                padding: 8px 0 !important;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px dashed #f1f5f9;
            }

            td:last-child {
                border-bottom: none;
                margin-top: 12px;
                padding-right: 0 !important;
                text-align: left !important;
            }

            td:before {
                content: attr(data-label);
                display: inline-block;
                font-weight: 800;
                text-transform: uppercase;
                font-size: 10px;
                color: #94a3b8;
                margin-right: 10px;
                min-width: 70px;
                flex-shrink: 0;
            }
        }

        .client-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0f2fe;
            color: #0369a1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .status-pill {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            letter-spacing: 0.5px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-pill-clickable {
            cursor: pointer;
        }

        .status-pill-clickable:hover {
            transform: scale(1.05);
            filter: brightness(0.9);
        }

        .status-completed {
            background: #dcfce7;
            color: #166534;
        }

        .status-processing {
            background: #fef9c3;
            color: #854d0e;
        }

        .status-on-hold {
            background: #ffedd5;
            color: #9a3412;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-cancelled,
        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-summary-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            background: white;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 900;
            color: #64748b;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }

        .status-summary-item:hover {
            transform: translateY(-2px);
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .status-summary-item.active-filter {
            border-color: var(--primary);
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        #modal-box {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        @media (max-width: 640px) {
            #modal-box {
                width: 100vw !important;
                height: 100vh !important;
                max-width: none !important;
                border-radius: 0 !important;
            }

            .passenger-info .meta-field-value {
                font-size: 16px;
            }

            .meta-field-value {
                font-size: 13px;
            }
        }

        @media (min-width: 641px) and (max-width: 1023px) {
            #modal-box {
                width: 100vw;
                height: 100vh;
                max-width: none;
                border-radius: 12px;
            }
        }

        @media (min-width: 1024px) {
            #modal-box {
                width: 95vw;
                height: 90vh;
                max-width: 1400px;
                border-radius: 16px;
            }
        }

        .meta-field-label {
            font-size: 10px;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .meta-field-value {
            font-weight: 700;
            color: var(--primary);
            font-size: 15px;
            line-height: 1.4;
        }

        .input-editable {
            width: 100%;
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            outline: none;
            transition: border-color 0.2s;
        }

        .input-editable:focus {
            border-color: var(--accent);
            background-color: white;
        }

        #input-email,
        #display-email {
            text-transform: lowercase;
        }

        .btn-whatsapp {
            background-color: var(--whatsapp);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
            width: 100%;
            margin-top: 8px;
        }

        .btn-email {
            background-color: var(--email-btn);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
            width: 100%;
            margin-top: 6px;
        }

        @media (min-width: 768px) {

            .btn-whatsapp,
            .btn-email {
                width: fit-content;
            }
        }

        .operation-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .operation-card-header {
            padding: 12px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .operation-card-title {
            font-size: 13px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .operation-card-body {
            padding: 20px;
        }

        .operation-section-label {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            color: #94a3b8;
            margin-bottom: 10px;
            letter-spacing: 1px;
            border-bottom: 1px dashed #e2e8f0;
            padding-bottom: 4px;
        }

        .route-visualizer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 20px;
            background: #002a3f;
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 42, 63, 0.15);
        }

        .route-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .route-point-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            opacity: 0.7;
            letter-spacing: 1px;
        }

        .route-point-name {
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            line-height: 1.2;
        }

        #route-separator-emoji {
            font-size: 28px;
        }

        .info-pill {
            background: #f1f5f9;
            color: #475569;
            padding: 6px 12px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #e2e8f0;
        }

        @media (min-width: 1024px) {
            .column-scroll {
                scrollbar-width: thin;
                scrollbar-color: #cbd5e1 transparent;
            }

            .column-scroll::-webkit-scrollbar {
                width: 6px;
            }

            .column-scroll::-webkit-scrollbar-track {
                background: transparent;
            }

            .column-scroll::-webkit-scrollbar-thumb {
                background-color: #cbd5e1;
                border-radius: 20px;
            }
        }

        .btn-section-edit {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            padding: 4px 10px;
            background: white;
            border: 1px solid #cbd5e1;
            color: #64748b;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .btn-section-edit:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-section-edit.editing {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .table-trip-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .table-trip-route {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            color: var(--primary);
            font-size: 14px;
        }

        .table-trip-label {
            font-size: 9px;
            font-weight: 900;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-sidebar {
            background-color: white;
            border-right: 1px solid #f1f5f9;
        }

        .modal-main-content {
            background-color: #f8fafc;
        }

        /* En pantallas grandes: sidebar fijo, contenido con scroll */
        @media (min-width: 1024px) {
            .modal-sidebar {
                overflow-y: auto;
                max-height: calc(100vh - 180px);
            }

            .modal-main-content {
                overflow-y: auto;
                max-height: calc(100vh - 180px);
            }
        }

        .field-group-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Responsive para sidebar del modal */
        @media (max-width: 1023px) {
            .modal-sidebar {
                width: 100% !important;
                border-right: none !important;
                border-bottom: 1px solid #e2e8f0;
            }
        }

        @media (max-width: 640px) {
            .modal-sidebar {
                width: 100% !important;
                border-right: none !important;
                border-bottom: 1px solid #e2e8f0;
            }

            .field-group-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        /* Indexing status (igual que en viajes) */
        #indexing-status {
            position: fixed;
            top: 14px;
            right: 150px;
            background: rgba(0, 42, 63, 0.95);
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            z-index: 120;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: none;
            backdrop-filter: blur(4px);
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
    </style>
</head>

<body>

    <!-- Indexing Status (reemplaza loader de reservas) -->
    <div id="indexing-status">
        <div id="status-icon" class="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
        <span id="indexing-text">Indexando...</span>
    </div>

    <!-- AQU√ç EST√Å EL MEN√ö CENTRALIZADO -->
    <admin-navbar></admin-navbar>

    <main class="main-container">
        <!-- Dashboard Header -->
        <div class="mb-8 flex flex-col xl:flex-row items-start xl:items-end justify-between gap-6">
            <div class="space-y-4 w-full xl:w-auto">
                <h2 class="text-2xl md:text-3xl font-bold text-[#002a3f] title-font">Reservas</h2>
                <div class="flex flex-wrap gap-3">
                    <div id="filter-pending" onclick="filterByStatus('pending')"
                        class="status-summary-item bg-amber-50 border-amber-100 text-amber-600">
                        <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                        <span id="stat-pending">0</span> PENDIENTES
                    </div>
                    <div id="clear-filter-btn" onclick="filterByStatus('')"
                        class="hidden status-summary-item bg-gray-100 border-gray-200 text-gray-500">
                        &times; QUITAR FILTRO
                    </div>
                </div>
            </div>

            <!-- Buscador Manual -->
            <div class="flex flex-col sm:flex-row gap-3 w-full xl:w-auto mt-4 xl:mt-0">
                <div class="relative flex-1 md:w-80">
                    <input type="text" id="search-input" oninput="handleSearchInput()"
                        onkeydown="if(event.key==='Enter') applyFilters()" placeholder="Buscar cliente, ID..."
                        class="bg-white border border-gray-200 shadow-sm rounded-xl px-10 py-3 pr-10 text-sm w-full focus:ring-2 focus:ring-[#ed4441]/20 outline-none h-12">
                    <span
                        class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg pointer-events-none">üîç</span>
                    <button id="btn-clear-search" onclick="clearSearch()"
                        class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 hover:text-gray-500 text-xl transition-all">&times;</button>
                </div>
                <button onclick="applyFilters()"
                    class="bg-[#002a3f] text-white px-6 h-12 rounded-xl font-bold uppercase text-[11px] tracking-widest hover:bg-[#ed4441] transition-all shadow-md">Buscar</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="main-table">
                <thead>
                    <tr>
                        <th class="w-20 pl-6">ID</th>
                        <th class="w-64">Cliente</th>
                        <th>Trayecto / Hotel</th>
                        <th>Fecha Reserva</th>
                        <th>Estado</th>
                        <th class="text-right pr-6">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="full-rows" class="space-y-4"></tbody>
            </table>
        </div>

        <div class="flex flex-col md:flex-row items-center justify-between mt-8 gap-4">
            <p class="text-[11px] font-bold text-gray-400 uppercase tracking-wider" id="pagination-info"></p>
            <div class="flex flex-wrap justify-center gap-2" id="pagination-controls"></div>
        </div>
    </main>

    <!-- Modal Detalle Responsivo -->
    <div id="order-modal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-0 md:p-4"
        onclick="closeModal()">
        <div id="modal-box" onclick="event.stopPropagation()" class="shadow-2xl overflow-hidden md:rounded-[24px]">
            <!-- Header Modal -->
            <div class="px-6 md:px-8 py-4 border-b flex justify-between items-center bg-white">
                <div class="flex flex-wrap items-center gap-4">
                    <h3 id="modal-title" class="text-xl md:text-2xl font-bold text-[#002a3f] title-font"></h3>

                    <div id="status-display-container" onclick="toggleStatusEditQuick()"
                        class="flex items-center gap-2 group cursor-pointer">
                        <span id="det-status-pill"
                            class="status-pill status-pill-clickable transition-all duration-300"></span>
                        <svg class="w-4 h-4 text-gray-400 group-hover:text-gray-600" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                            </path>
                        </svg>
                    </div>

                    <div id="status-edit-container" class="hidden">
                        <select id="input-status" onchange="checkForChanges()"
                            class="bg-white border-2 border-gray-200 rounded-lg px-3 py-1 text-sm font-bold uppercase outline-none focus:border-[#ed4441]">
                            <option value="pending">Pendiente</option>
                            <option value="processing">Procesando</option>
                            <option value="on-hold">Espera</option>
                            <option value="completed">Completado</option>
                            <option value="cancelled">Cancelado</option>
                            <option value="failed">Fallido</option>
                        </select>
                    </div>
                </div>

                <button onclick="closeModal()"
                    class="text-3xl text-gray-300 hover:text-gray-600 transition">&times;</button>
            </div>

            <div class="flex-1 lg:overflow-hidden overflow-y-auto column-scroll flex flex-col lg:flex-row">
                <!-- Columna Izquierda: Cliente (Sidebar) -->
                <div class="modal-sidebar w-full lg:w-[320px] lg:flex-shrink-0 border-r">
                    <div class="p-6 md:p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-[11px] font-black text-gray-400 uppercase tracking-widest">Cliente</h4>
                            <button id="btn-edit-passenger" onclick="togglePassengerEdit()"
                                class="btn-section-edit">Editar</button>
                        </div>

                        <div class="flex flex-col items-center mb-6">
                            <div
                                class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center text-3xl mb-3">
                                üë§</div>
                            <div id="display-name" class="font-bold text-xl text-[#002a3f] text-center leading-tight">
                            </div>
                            <input type="text" id="input-name" oninput="checkForChanges()"
                                class="hidden input-editable text-center mt-2" placeholder="Nombre completo">
                        </div>

                        <div class="space-y-6">
                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                                <p class="meta-field-label">üìß Correo</p>
                                <div id="display-email" class="meta-field-value break-all"></div>
                                <input type="email" id="input-email" oninput="handleEmailInput()"
                                    class="hidden input-editable" placeholder="ejemplo@correo.com">
                                <a id="det-email-link" href="#" class="btn-email">Enviar Correo</a>
                            </div>

                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                                <p class="meta-field-label">üìû Tel√©fono</p>
                                <div id="display-phone" class="meta-field-value"></div>
                                <input type="text" id="input-phone" oninput="checkForChanges()"
                                    class="hidden input-editable" placeholder="+000 0000 0000">
                                <a id="det-whatsapp-link" href="#" target="_blank" class="btn-whatsapp">WhatsApp</a>
                            </div>

                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                                <p class="meta-field-label">üåç Pa√≠s</p>
                                <div id="display-country" class="meta-field-value"></div>
                                <select id="input-country" onchange="checkForChanges()" class="hidden input-editable">
                                    <option value="">Selecciona un pa√≠s</option>
                                </select>
                            </div>

                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                                <p class="meta-field-label">üìç Direcci√≥n</p>
                                <div id="display-address" class="meta-field-value text-sm"></div>
                                <textarea id="input-address" oninput="checkForChanges()" rows="2"
                                    class="hidden input-editable resize-none"
                                    placeholder="Direcci√≥n completa"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha: Operaciones (Main Content) -->
                <div class="modal-main-content flex-1 p-6 md:p-8">
                    <!-- Secci√≥n de Ruta y Resumen -->
                    <div id="general-service-info" class="hidden">
                        <div id="route-display" class="route-visualizer">
                            <div class="route-point">
                                <span class="text-3xl" id="origin-icon">‚úàÔ∏è</span>
                                <span class="route-point-label" id="origin-label">Origen</span>
                                <span class="route-point-name" id="origin-name">LIR Airport</span>
                            </div>

                            <div class="route-separator-container">
                                <span id="route-separator-emoji">‚û°Ô∏è</span>
                            </div>

                            <div class="route-point">
                                <span class="text-3xl" id="dest-icon">üè®</span>
                                <span class="route-point-label" id="dest-label">Destino</span>
                                <span class="route-point-name" id="dest-name">Hotel Name</span>
                            </div>
                        </div>

                        <!-- P√≠ldoras Resumen -->
                        <div class="flex flex-wrap gap-3 mb-8">
                            <div class="info-pill bg-white shadow-sm">
                                <span class="text-gray-400 text-[10px] uppercase font-bold">Tipo:</span>
                                <span id="general-trip-type" class="font-bold text-[#002a3f] uppercase"></span>
                            </div>
                            <div class="info-pill bg-white shadow-sm">
                                <span class="text-gray-400 text-[10px] uppercase font-bold">Pax:</span>
                                <span id="general-pax-value" class="font-bold text-[#002a3f]"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Grid de Log√≠stica y Asignaci√≥n -->
                    <div id="logistics-container" class="grid grid-cols-1 gap-6 mb-8">
                        <!-- Tarjeta Llegada -->
                        <div id="col-arrival" class="operation-card">
                            <div class="operation-card-header">
                                <div class="operation-card-title">
                                    <span class="title-dot-arrival"></span> LLEGADA
                                </div>
                                <button id="btn-edit-arrival" onclick="toggleArrivalEdit()"
                                    class="btn-section-edit">Editar</button>
                            </div>
                            <div class="operation-card-body space-y-5">
                                <!-- Log√≠stica -->
                                <div>
                                    <div id="arrival-fields-list" class="grid grid-cols-2 gap-4"></div>
                                </div>

                                <!-- Asignaci√≥n -->
                                <div class="bg-blue-50/50 -mx-5 -mb-5 p-5 border-t border-blue-100">
                                    <div class="operation-section-label text-blue-400 border-blue-200">Asignaci√≥n
                                        Operativa</div>
                                    <div class="space-y-4">
                                        <div class="field-group-row">
                                            <div>
                                                <p class="meta-field-label">üöê Chofer</p>
                                                <select id="input-meta-chofer_llegada" onchange="checkForChanges()"
                                                    class="input-editable bg-white"></select>
                                            </div>
                                            <div>
                                                <p class="meta-field-label">üë• Subchofer</p>
                                                <input type="text" id="input-meta-subchofer_llegada"
                                                    oninput="checkForChanges()" class="input-editable bg-white"
                                                    placeholder="Nombre del subchofer">
                                            </div>
                                        </div>
                                        <div>
                                            <p class="meta-field-label">üì¢ Nota Choferes</p>
                                            <textarea id="input-meta-nota_choferes_llegada" oninput="checkForChanges()"
                                                rows="2" class="input-editable bg-white resize-none h-16"></textarea>
                                        </div>
                                        <div>
                                            <p class="meta-field-label">üîí Notas Internas</p>
                                            <textarea id="input-meta-notas_internas_llegada" oninput="checkForChanges()"
                                                rows="2" class="input-editable bg-white resize-none h-16"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tarjeta Salida -->
                        <div id="col-departure" class="operation-card">
                            <div class="operation-card-header">
                                <div class="operation-card-title">
                                    <span class="title-dot-departure"></span> SALIDA
                                </div>
                                <button id="btn-edit-departure" onclick="toggleDepartureEdit()"
                                    class="btn-section-edit">Editar</button>
                            </div>
                            <div class="operation-card-body space-y-5">
                                <!-- Log√≠stica -->
                                <div>
                                    <div id="departure-fields-list" class="grid grid-cols-2 gap-4"></div>
                                </div>

                                <!-- Asignaci√≥n -->
                                <div class="bg-orange-50/50 -mx-5 -mb-5 p-5 border-t border-orange-100">
                                    <div class="operation-section-label text-orange-400 border-orange-200">Asignaci√≥n
                                        Operativa</div>
                                    <div class="space-y-4">
                                        <div class="field-group-row">
                                            <div>
                                                <p class="meta-field-label">üöê Chofer</p>
                                                <select id="input-meta-chofer_salida" onchange="checkForChanges()"
                                                    class="input-editable bg-white"></select>
                                            </div>
                                            <div>
                                                <p class="meta-field-label">üë• Subchofer</p>
                                                <input type="text" id="input-meta-subchofer_salida"
                                                    oninput="checkForChanges()" class="input-editable bg-white"
                                                    placeholder="Nombre del subchofer">
                                            </div>
                                        </div>
                                        <div>
                                            <p class="meta-field-label">üì¢ Nota Choferes</p>
                                            <textarea id="input-meta-nota_choferes_ida" oninput="checkForChanges()"
                                                rows="2" class="input-editable bg-white resize-none h-16"></textarea>
                                        </div>
                                        <div>
                                            <p class="meta-field-label">üîí Notas Internas</p>
                                            <textarea id="input-meta-notas_internas_salida" oninput="checkForChanges()"
                                                rows="2" class="input-editable bg-white resize-none h-16"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de Pago -->
                    <div id="order-totals-container" class="mt-4">
                        <div class="bg-white border rounded-xl p-5 shadow-sm max-w-md ml-auto">
                            <h5 class="operation-section-label mb-4" style="border:none;">Resumen Financiero</h5>
                            <div id="payment-breakdown-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Modal -->
            <div class="p-4 border-t bg-white flex justify-end gap-3 rounded-b-xl">
                <button onclick="saveOrderDetails()" id="btn-save"
                    class="hidden px-6 py-2 bg-green-600 text-white rounded-lg font-bold text-xs uppercase tracking-widest hover:bg-green-700 transition-all shadow-md">Guardar
                    Cambios</button>
                <button onclick="closeModal()"
                    class="px-6 py-2 bg-gray-100 text-gray-600 rounded-lg font-bold text-xs uppercase tracking-widest hover:bg-gray-200 transition">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // API Local - Lee desde la base de datos MySQL
        const API_PROXY = "api/reservas.php";

        // CALCULAR FECHA DE INICIO (7 meses atr√°s)
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 7);
        // Formato ISO8601 para WooCommerce: YYYY-MM-DDTHH:MM:SS
        const START_DATE_FILTER = startDate.toISOString().split('.')[0];

        // --- UTILIDADES ---
        function formatDateShort(d) {
            if (!d) return '---';
            let dateObj = new Date(d);

            if (typeof d === 'string') {
                const datePart = d.split('T')[0];
                if (datePart.includes('-')) {
                    const parts = datePart.split('-');
                    if (parts.length === 3) {
                        dateObj = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    }
                }
            }

            if (isNaN(dateObj.getTime())) return d;

            const day = dateObj.getDate().toString().padStart(2, '0');
            const months = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
            const month = months[dateObj.getMonth()];
            const year = dateObj.getFullYear();

            return `${day}/${month}/${year}`;
        }

        function formatTime12h(timeStr) {
            if (!timeStr || timeStr.toLowerCase().includes('am') || timeStr.toLowerCase().includes('pm')) return timeStr;
            const match = timeStr.match(/^(\d{1,2}):(\d{2})/);
            if (!match) return timeStr;
            let hours = parseInt(match[1]);
            const minutes = match[2];
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12;
            return `${hours}:${minutes} ${ampm}`;
        }

        function normalizeForInput(val, type) {
            if (!val) return "";
            if (type === 'date') return val.split('T')[0].split(' ')[0];
            if (type === 'time') {
                const match = val.match(/(\d{1,2}):(\d{2})/);
                if (match) {
                    let h = parseInt(match[1]);
                    if (val.toLowerCase().includes('pm') && h < 12) h += 12;
                    if (val.toLowerCase().includes('am') && h === 12) h = 0;
                    return `${h.toString().padStart(2, '0')}:${match[2]}`;
                }
            }
            return val;
        }

        function formatPhoneNumber(phone, countryCode) {
            if (!phone) return 'N/A';
            const clean = phone.replace(/\D/g, '');
            const country = countryCode?.toUpperCase() || '';
            const prefixes = { 'CR': '506', 'US': '1', 'CA': '1', 'MX': '52', 'ES': '34' };
            const prefix = prefixes[country] || '';
            let raw = clean;
            if (prefix && clean.startsWith(prefix)) raw = clean.slice(prefix.length);
            if (country === 'CR') return `+506 ${raw.length === 8 ? `${raw.slice(0, 4)} ${raw.slice(4)}` : raw}`;
            return prefix ? `+${prefix} ${raw}` : raw;
        }

        function getInitials(name) {
            if (!name) return "##";
            const parts = name.split(" ");
            let initials = parts[0].substring(0, 1).toUpperCase();
            if (parts.length > 1) initials += parts[parts.length - 1].substring(0, 1).toUpperCase();
            return initials;
        }

        const COUNTRY_MAP = { 'AF': { name: 'Afganist√°n' }, 'AL': { name: 'Albania' }, 'DZ': { name: 'Argelia' }, 'AD': { name: 'Andorra' }, 'AO': { name: 'Angola' }, 'AG': { name: 'Antigua y Barbuda' }, 'AR': { name: 'Argentina' }, 'AM': { name: 'Armenia' }, 'AU': { name: 'Australia' }, 'AT': { name: 'Austria' }, 'AZ': { name: 'Azerbaiy√°n' }, 'BS': { name: 'Bahamas' }, 'BH': { name: 'Bar√©in' }, 'BD': { name: 'Banglad√©s' }, 'BB': { name: 'Barbados' }, 'BY': { name: 'Bielorrusia' }, 'BE': { name: 'B√©lgica' }, 'BZ': { name: 'Belice' }, 'BJ': { name: 'Ben√≠n' }, 'BT': { name: 'But√°n' }, 'BO': { name: 'Bolivia' }, 'BA': { name: 'Bosnia y Herzegovina' }, 'BW': { name: 'Botsuana' }, 'BR': { name: 'Brasil' }, 'BN': { name: 'Brun√©i' }, 'BG': { name: 'Bulgaria' }, 'BF': { name: 'Burkina Faso' }, 'BI': { name: 'Burundi' }, 'KH': { name: 'Camboya' }, 'CM': { name: 'Camer√∫n' }, 'CA': { name: 'Canad√°' }, 'CV': { name: 'Cabo Verde' }, 'CF': { name: 'Rep√∫blica Centroafricana' }, 'TD': { name: 'Chad' }, 'CL': { name: 'Chile' }, 'CN': { name: 'China' }, 'CO': { name: 'Colombia' }, 'KM': { name: 'Comoras' }, 'CG': { name: 'Congo' }, 'CD': { name: 'Congo, Rep√∫blica Democr√°tica del' }, 'CR': { name: 'Costa Rica' }, 'HR': { name: 'Croacia' }, 'CU': { name: 'Cuba' }, 'CY': { name: 'Chipre' }, 'CZ': { name: 'Rep√∫blica Checa' }, 'DK': { name: 'Dinamarca' }, 'DJ': { name: 'Yibuti' }, 'DM': { name: 'Dominica' }, 'DO': { name: 'Rep√∫blica Dominicana' }, 'EC': { name: 'Ecuador' }, 'EG': { name: 'Egipto' }, 'SV': { name: 'El Salvador' }, 'GQ': { name: 'Guinea Ecuatorial' }, 'ER': { name: 'Eritrea' }, 'EE': { name: 'Estonia' }, 'ET': { name: 'Etiop√≠a' }, 'FJ': { name: 'Fiyi' }, 'FI': { name: 'Finlandia' }, 'FR': { name: 'Francia' }, 'GA': { name: 'Gab√≥n' }, 'GM': { name: 'Gambia' }, 'GE': { name: 'Georgia' }, 'DE': { name: 'Alemania' }, 'GH': { name: 'Ghana' }, 'GR': { name: 'Grecia' }, 'GD': { name: 'Granada' }, 'GT': { name: 'Guatemala' }, 'GN': { name: 'Guinea' }, 'GW': { name: 'Guinea-Bis√°u' }, 'GY': { name: 'Guyana' }, 'HT': { name: 'Hait√≠' }, 'HN': { name: 'Honduras' }, 'HU': { name: 'Hungr√≠a' }, 'IS': { name: 'Islandia' }, 'IN': { name: 'India' }, 'ID': { name: 'Indonesia' }, 'IR': { name: 'Ir√°n' }, 'IQ': { name: 'Irak' }, 'IE': { name: 'Irlanda' }, 'IL': { name: 'Israel' }, 'IT': { name: 'Italia' }, 'JM': { name: 'Jamaica' }, 'JP': { name: 'Jap√≥n' }, 'JO': { name: 'Jordania' }, 'KZ': { name: 'Kazajist√°n' }, 'KE': { name: 'Kenia' }, 'KI': { name: 'Kiribati' }, 'KW': { name: 'Kuwait' }, 'KG': { name: 'Kirguist√°n' }, 'LA': { name: 'Laos' }, 'LV': { name: 'Letonia' }, 'LB': { name: 'L√≠bano' }, 'LS': { name: 'Lesoto' }, 'LR': { name: 'Liberia' }, 'LY': { name: 'Libia' }, 'LI': { name: 'Liechtenstein' }, 'LT': { name: 'Lituania' }, 'LU': { name: 'Luxemburgo' }, 'MK': { name: 'Macedonia del Norte' }, 'MG': { name: 'Madagascar' }, 'MW': { name: 'Malaui' }, 'MY': { name: 'Malasia' }, 'MV': { name: 'Maldivas' }, 'ML': { name: 'Mal√≠' }, 'MT': { name: 'Malta' }, 'MH': { name: 'Islas Marshall' }, 'MR': { name: 'Mauritania' }, 'MU': { name: 'Mauricio' }, 'MX': { name: 'M√©xico' }, 'FM': { name: 'Micronesia' }, 'MD': { name: 'Moldavia' }, 'MC': { name: 'M√≥naco' }, 'MN': { name: 'Mongolia' }, 'ME': { name: 'Montenegro' }, 'MA': { name: 'Marruecos' }, 'MZ': { name: 'Mozambique' }, 'MM': { name: 'Myanmar' }, 'NA': { name: 'Namibia' }, 'NR': { name: 'Nauru' }, 'NP': { name: 'Nepal' }, 'NL': { name: 'Pa√≠ses Bajos' }, 'NZ': { name: 'Nueva Zelanda' }, 'NI': { name: 'Nicaragua' }, 'NE': { name: 'N√≠ger' }, 'NG': { name: 'Nigeria' }, 'KP': { name: 'Corea del Norte' }, 'NO': { name: 'Noruega' }, 'OM': { name: 'Om√°n' }, 'PK': { name: 'Pakist√°n' }, 'PW': { name: 'Palaos' }, 'PA': { name: 'Panam√°' }, 'PG': { name: 'Pap√∫a Nueva Guinea' }, 'PY': { name: 'Paraguay' }, 'PE': { name: 'Per√∫' }, 'PH': { name: 'Filipinas' }, 'PL': { name: 'Polonia' }, 'PT': { name: 'Portugal' }, 'QA': { name: 'Catar' }, 'RO': { name: 'Rumania' }, 'RU': { name: 'Rusia' }, 'RW': { name: 'Ruanda' }, 'KN': { name: 'San Crist√≥bal y Nieves' }, 'LC': { name: 'Santa Luc√≠a' }, 'VC': { name: 'San Vicente y las Granadinas' }, 'WS': { name: 'Samoa' }, 'SM': { name: 'San Marino' }, 'ST': { name: 'Santo Tom√© y Pr√≠ncipe' }, 'SA': { name: 'Arabia Saudita' }, 'SN': { name: 'Senegal' }, 'RS': { name: 'Serbia' }, 'SC': { name: 'Seychelles' }, 'SL': { name: 'Sierra Leona' }, 'SG': { name: 'Singapur' }, 'SK': { name: 'Eslovaquia' }, 'SI': { name: 'Eslovenia' }, 'SB': { name: 'Islas Salom√≥n' }, 'SO': { name: 'Somalia' }, 'ZA': { name: 'Sud√°frica' }, 'KR': { name: 'Corea del Sur' }, 'ES': { name: 'Espa√±a' }, 'LK': { name: 'Sri Lanka' }, 'SD': { name: 'Sud√°n' }, 'SR': { name: 'Surinam' }, 'SZ': { name: 'Esuatini' }, 'SE': { name: 'Suecia' }, 'CH': { name: 'Suiza' }, 'SY': { name: 'Siria' }, 'TW': { name: 'Taiw√°n' }, 'TJ': { name: 'Tayikist√°n' }, 'TZ': { name: 'Tanzania' }, 'TH': { name: 'Tailandia' }, 'TL': { name: 'Timor Oriental' }, 'TG': { name: 'Togo' }, 'TO': { name: 'Tonga' }, 'TT': { name: 'Trinidad y Tobago' }, 'TN': { name: 'T√∫nez' }, 'TR': { name: 'Turqu√≠a' }, 'TM': { name: 'Turkmenist√°n' }, 'TV': { name: 'Tuvalu' }, 'UG': { name: 'Uganda' }, 'UA': { name: 'Ucrania' }, 'AE': { name: 'Emiratos √Årabes Unidos' }, 'GB': { name: 'Reino Unido' }, 'US': { name: 'Estados Unidos' }, 'UY': { name: 'Uruguay' }, 'UZ': { name: 'Uzbekist√°n' }, 'VU': { name: 'Vanuatu' }, 'VE': { name: 'Venezuela' }, 'VN': { name: 'Vietnam' }, 'YE': { name: 'Yemen' }, 'ZM': { name: 'Zambia' }, 'ZW': { name: 'Zimbabue' } };

        // Choferes se cargan desde la BD
        let CHOFERES = [];

        const ARRIVAL_FIELDS = [
            { label: "Fecha", key: "- Arrival Date", emoji: "üìÖ", type: "date" },
            { label: "Hora", key: "- Arrival Time", emoji: "üïí", type: "time" },
            { label: "Vuelo", key: "- Arrival Flight Number", emoji: "üõ¨", type: "text" }
        ];

        const DEPARTURE_FIELDS = [
            { label: "Fecha de recogida", key: "- Departure Date", emoji: "üóìÔ∏è", type: "date" },
            { label: "Hora de recogida", key: "- Pick-up Time at Hotel", emoji: "üïí", type: "time" },
            { label: "Vuelo", key: "- Departure Flight Number", emoji: "üõ´", type: "text" }
        ];

        const ASSIGN_KEYS = [
            "chofer_llegada", "subchofer_llegada", "nota_choferes_llegada", "notas_internas_llegada",
            "chofer_salida", "subchofer_salida", "nota_choferes_ida", "notas_internas_salida"
        ];

        const PASSENGER_EDIT_KEYS = ["name", "email", "phone", "country", "address"];

        let allOrders = [];  // Todas las √≥rdenes indexadas
        let currentFilteredOrders = [];  // √ìrdenes despu√©s de aplicar filtros
        let currentOrders = [];  // √ìrdenes en la p√°gina actual (para compatibilidad con modal)
        let currentOrderId = null;
        let currentPage = 1;
        let totalPages = 1;
        let totalOrders = 0;
        const pageSize = 10;
        let originalValues = {};
        let editingSections = { passenger: false, arrival: false, departure: false };
        let currentStatusFilter = "";
        let isIndexing = false;
        let indexingRunId = 0;

        window.onload = async () => {
            await loadChoferes();
            initCountryDropdown();
            initChoferSelects();
            startBackgroundIndexing();
        };

        async function loadChoferes() {
            try {
                const response = await fetch('api/choferes.php');
                if (response.ok) {
                    const data = await response.json();
                    CHOFERES = data.map(c => c.nombre);
                }
            } catch (err) {
                console.error('Error cargando choferes:', err);
            }
        }

        window.refreshData = function (page = 1) {
            // Reiniciar estado y forzar nueva indexaci√≥n
            allOrders = [];
            currentFilteredOrders = [];
            renderTable();
            startBackgroundIndexing(true);
        };

        function initCountryDropdown() {
            const select = document.getElementById('input-country');
            Object.keys(COUNTRY_MAP).sort((a, b) => COUNTRY_MAP[a].name.localeCompare(COUNTRY_MAP[b].name)).forEach(code => {
                const opt = document.createElement('option');
                opt.value = code; opt.textContent = COUNTRY_MAP[code].name;
                select.appendChild(opt);
            });
        }

        function initChoferSelects() {
            const selects = ["chofer_llegada", "chofer_salida"];
            selects.forEach(id => {
                const sel = document.getElementById(`input-meta-${id}`);
                if (!sel) return;
                sel.innerHTML = '<option value="">No asignado</option>';
                CHOFERES.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = c;
                    sel.appendChild(opt);
                });
            });
        }

        function getCountryDisplayName(code) { return code ? (COUNTRY_MAP[code.toUpperCase()]?.name || code.toUpperCase()) : 'N/A'; }

        async function startBackgroundIndexing(force = false) {
            if (isIndexing && !force) return;
            if (force) indexingRunId++;
            const runId = indexingRunId;
            isIndexing = true;
            toggleLoader(true);

            let page = 1;
            let totalPagesAPI = 1;
            let keepFetching = true;

            try {
                while (keepFetching) {
                    const response = await fetch(`${API_PROXY}?per_page=100&page=${page}&after=${START_DATE_FILTER}&orderby=date&order=desc`);

                    if (!response.ok) throw new Error("Error API");
                    if (runId !== indexingRunId) break;

                    if (page === 1) {
                        const totalHeader = response.headers.get('x-wp-totalpages');
                        if (totalHeader) totalPagesAPI = parseInt(totalHeader);
                    }

                    const orders = await response.json();
                    if (runId !== indexingRunId) break;

                    if (Array.isArray(orders) && orders.length > 0) {
                        allOrders = [...allOrders, ...orders];
                        // Ordenar por fecha de creaci√≥n (m√°s recientes primero)
                        allOrders.sort((a, b) => new Date(b.date_created) - new Date(a.date_created));

                        applyFilters();

                        const progress = Math.min(100, Math.round((page / totalPagesAPI) * 100));
                        updateProgressUI(progress, `Indexando ${progress}%`);

                        if (page >= totalPagesAPI || orders.length < 100) {
                            keepFetching = false;
                        } else {
                            page++;
                        }
                    } else {
                        keepFetching = false;
                    }

                    if (page > 50) keepFetching = false;
                }

                if (runId === indexingRunId) {
                    showCompletionState();
                    setAPIStatus('online');
                }

            } catch (error) {
                console.error(error);
                updateProgressUI(100, "Error de conexi√≥n");
                setAPIStatus('error');
                setTimeout(() => toggleLoader(false), 3000);
            } finally {
                if (runId === indexingRunId) {
                    isIndexing = false;
                }
            }
        }

        function applyFilters() {
            const searchText = document.getElementById('search-input').value.toLowerCase().trim();

            let filtered = allOrders;

            // Filtrar por estado
            if (currentStatusFilter) {
                filtered = filtered.filter(o => o.status === currentStatusFilter);
            }

            // Filtrar por b√∫squeda
            if (searchText) {
                filtered = filtered.filter(o => {
                    const name = resolveName(o).toLowerCase();
                    const id = o.id.toString();
                    const hotel = (o.line_items?.[0]?.name || '').toLowerCase();
                    return name.includes(searchText) || id.includes(searchText) || hotel.includes(searchText);
                });
            }

            currentFilteredOrders = filtered;
            totalOrders = filtered.length;
            totalPages = Math.ceil(totalOrders / pageSize) || 1;

            // Asegurar que la p√°gina actual es v√°lida
            if (currentPage > totalPages) currentPage = 1;

            renderTable();
            updatePaginationUI();
            updateStats();
        }

        function goToPage(page) {
            currentPage = page;
            renderTable();
            updatePaginationUI();
        }

        function updateProgressUI(percent, text) {
            const apiBadge = document.getElementById('api-status-badge');
            const apiLabel = apiBadge ? apiBadge.querySelector('span:last-child') : null;
            if (apiLabel) apiLabel.textContent = text;
        }

        function showCompletionState() {
            toggleLoader(false);
            updateProgressUI(100, "Online");
        }

        function updateStats() {
            // Contar pendientes desde los datos locales
            const pendingCount = allOrders.filter(o => o.status === 'pending').length;
            document.getElementById('stat-pending').innerText = pendingCount;
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            currentPage = 1;  // Resetear a primera p√°gina al filtrar
            if (status === 'pending') {
                document.getElementById('filter-pending').classList.add('active-filter');
            } else {
                document.getElementById('filter-pending').classList.remove('active-filter');
            }
            document.getElementById('clear-filter-btn').classList.toggle('hidden', status === '');
            applyFilters();
        }

        function formatTripTypeTable(order) {
            const tripRaw = deepScanMeta(order, "- Type of Trip") || "";
            const hotel = order.line_items?.[0]?.name || 'Hotel no especificado';
            const isRound = tripRaw.toLowerCase().includes('round');
            const hasArrival = deepScanMeta(order, "- Arrival Date") !== null;

            let routeHTML = "";
            let label = "";

            if (isRound) {
                routeHTML = `<span>Aeropuerto üîÑ</span> <span class="font-bold">${hotel}</span>`;
                label = "Ida y Vuelta";
            } else if (hasArrival) {
                routeHTML = `<span>üõ¨ Aeropuerto ‚û°Ô∏è</span> <span class="font-bold">${hotel}</span>`;
                label = "Solo Llegada";
            } else {
                routeHTML = `<span class="font-bold">${hotel}</span> <span>‚û°Ô∏è Aeropuerto üõ´</span>`;
                label = "Solo Salida";
            }

            return `
                <div class="table-trip-cell">
                    <div class="table-trip-route">${routeHTML}</div>
                    <div class="table-trip-label">${label}</div>
                </div>
            `;
        }

        function renderTable() {
            const container = document.getElementById('full-rows');
            container.innerHTML = '';

            // Obtener las √≥rdenes de la p√°gina actual desde los datos filtrados
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const ordersToShow = currentFilteredOrders.slice(startIndex, endIndex);

            // Mantener currentOrders para compatibilidad con viewOrder
            currentOrders = ordersToShow;

            if (ordersToShow.length === 0) {
                container.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-400 font-bold uppercase text-xs">No se encontraron registros</td></tr>`;
                return;
            }
            ordersToShow.forEach(order => {
                const name = resolveName(order);
                const initials = getInitials(name);

                container.innerHTML += `
                    <tr>
                        <td data-label="ID" class="pl-6 font-bold text-gray-400">#${order.id}</td>
                        <td data-label="Cliente">
                            <div class="flex items-center">
                                <div class="client-avatar">${initials}</div>
                                <div class="flex flex-col justify-center">
                                    <span class="font-bold text-[#002a3f] text-base">${name}</span>
                                </div>
                            </div>
                        </td>
                        <td data-label="Trayecto" class="py-3">${formatTripTypeTable(order)}</td>
                        <td data-label="Fecha">
                            <div class="flex flex-col justify-center">
                                <span class="font-bold text-[#002a3f]">${formatDateShort(order.date_created)}</span>
                            </div>
                        </td>
                        <td data-label="Estado">
                            <div class="status-pill status-${order.status}">
                                <span class="status-dot"></span>
                                ${translateStatus(order.status)}
                            </div>
                        </td>
                        <td data-label="Acci√≥n" class="text-right pr-6">
                            <button onclick="viewOrder(${order.id})" class="bg-[#002a3f] text-white px-4 py-2 rounded-lg font-bold uppercase text-xs hover:bg-[#ed4441] transition-all" title="Ver detalle">
                                VER
                            </button>
                        </td>
                    </tr>`;
            });
        }

        async function viewOrder(id) {
            // Buscar primero en la p√°gina actual, luego en todos los datos
            let o = currentOrders.find(x => x.id === id);
            if (!o) o = allOrders.find(x => x.id === id);
            if (!o) return;
            currentOrderId = id;
            editingSections = { passenger: false, arrival: false, departure: false };
            document.body.style.overflow = 'hidden';

            document.getElementById('modal-title').innerText = `Reserva #${o.id}`;
            document.getElementById('btn-save').classList.add('hidden');

            const fullName = resolveName(o);
            const email = (o.billing.email || "").toLowerCase();
            const phone = o.billing.phone || "";
            const country = (o.billing.country || "").toUpperCase();
            const address = resolveAddress(o);
            const addressOnlyLine1 = (o.shipping?.address_1 || o.billing?.address_1 || "");
            const addressCity = (o.shipping?.city || o.billing?.city || "");

            originalValues = { name: fullName, email, phone, country, address, status: o.status };

            document.getElementById('display-name').innerText = fullName;
            document.getElementById('display-email').innerText = email;
            document.getElementById('display-phone').innerHTML = `<a href="tel:${phone}" class="hover:text-accent">${formatPhoneNumber(phone, country)}</a>`;
            document.getElementById('display-country').innerText = getCountryDisplayName(country);
            document.getElementById('display-address').innerText = address;

            document.getElementById('det-email-link').href = `mailto:${email}`;
            document.getElementById('det-whatsapp-link').href = `https://wa.me/${phone.replace(/\D/g, '')}`;

            document.getElementById('input-name').value = fullName;
            document.getElementById('input-email').value = email;
            document.getElementById('input-phone').value = phone;
            document.getElementById('input-country').value = country;
            document.getElementById('input-address').value = addressOnlyLine1;
            document.getElementById('input-status').value = o.status;

            PASSENGER_EDIT_KEYS.forEach(k => {
                document.getElementById(`display-${k}`)?.classList.remove('hidden');
                document.getElementById(`input-${k}`)?.classList.add('hidden');
            });
            document.getElementById('btn-edit-passenger').innerText = "Editar";
            document.getElementById('btn-edit-passenger').classList.remove('editing');

            const pill = document.getElementById('det-status-pill');
            pill.innerText = translateStatus(o.status);
            pill.className = `status-pill status-pill-clickable status-${o.status}`;
            document.getElementById('status-display-container').classList.remove('hidden');
            document.getElementById('status-edit-container').classList.add('hidden');

            renderLogisticsSections(o);
            renderGeneralInfo(o);
            renderPaymentInfo(o);

            document.getElementById('order-modal').classList.remove('hidden');
        }

        function renderLogisticsSections(o) {
            const listArr = document.getElementById('arrival-fields-list');
            const listDep = document.getElementById('departure-fields-list');
            listArr.innerHTML = ''; listDep.innerHTML = '';

            const renderLogistics = (fields, container) => {
                fields.forEach(f => {
                    const key = f.key;
                    const val = deepScanMeta(o, key);
                    originalValues[key] = val || "";
                    if (val !== null) {
                        const display = f.type === 'date' ? formatDateShort(val) : (f.type === 'time' ? formatTime12h(val) : val);
                        container.innerHTML += `
                            <div>
                                <p class="meta-field-label text-gray-400">${f.label}</p>
                                <p id="display-meta-${key}" class="meta-field-value text-base">${display}</p>
                                <input type="${f.type}" id="input-meta-${key}" oninput="checkForChanges()" value="${normalizeForInput(val, f.type)}" class="hidden input-editable mt-1">
                            </div>`;
                    }
                });
            };

            renderLogistics(ARRIVAL_FIELDS, listArr);
            renderLogistics(DEPARTURE_FIELDS, listDep);

            ASSIGN_KEYS.forEach(key => {
                const val = deepScanMeta(o, key);
                originalValues[key] = val || "";
                const inputEl = document.getElementById(`input-meta-${key}`);
                if (inputEl) {
                    inputEl.value = val || "";
                    inputEl.classList.remove('hidden');
                }
            });

            [document.getElementById('btn-edit-arrival'), document.getElementById('btn-edit-departure')].forEach(btn => {
                btn.innerText = "Editar";
                btn.classList.remove('editing');
            });

            const hasArrival = deepScanMeta(o, "- Arrival Date") !== null;
            const hasDeparture = deepScanMeta(o, "- Departure Date") !== null;

            document.getElementById('col-arrival').classList.toggle('hidden', !hasArrival);
            document.getElementById('col-departure').classList.toggle('hidden', !hasDeparture);

            const container = document.getElementById('logistics-container');
            if (hasArrival && hasDeparture) {
                container.classList.add('xl:grid-cols-2');
            } else {
                container.classList.remove('xl:grid-cols-2');
            }
        }

        function renderGeneralInfo(o) {
            const hotelName = o.line_items?.[0]?.name || 'Hotel no especificado';
            const tripRaw = deepScanMeta(o, "- Type of Trip");
            const paxRaw = (deepScanMeta(o, "Passengers") || o.line_items?.[0]?.quantity || '1').toString().split('-')[0].trim();
            const tripTypeFormatted = translateTripType(o, tripRaw);

            document.getElementById('general-service-info').classList.remove('hidden');
            document.getElementById('general-trip-type').innerText = tripTypeFormatted;
            document.getElementById('general-pax-value').innerText = paxRaw;

            const originNameEl = document.getElementById('origin-name');
            const destNameEl = document.getElementById('dest-name');
            const originIconEl = document.getElementById('origin-icon');
            const destIconEl = document.getElementById('dest-icon');
            const separatorEmojiEl = document.getElementById('route-separator-emoji');

            const isRoundTrip = tripTypeFormatted.includes('Vuelta');
            const isToHotel = deepScanMeta(o, "- Arrival Date") !== null;

            if (isRoundTrip) {
                originIconEl.innerText = "‚úàÔ∏è";
                originNameEl.innerText = "Aeropuerto LIR";
                destIconEl.innerText = "üè®";
                destNameEl.innerText = hotelName;
                separatorEmojiEl.innerText = "üîÑ";
            } else if (isToHotel) {
                originIconEl.innerText = "üõ¨";
                originNameEl.innerText = "Aeropuerto LIR";
                destIconEl.innerText = "üè®";
                destNameEl.innerText = hotelName;
                separatorEmojiEl.innerText = "‚û°Ô∏è";
            } else {
                originIconEl.innerText = "üè®";
                originNameEl.innerText = hotelName;
                destIconEl.innerText = "üõ´";
                destNameEl.innerText = "Aeropuerto LIR";
                separatorEmojiEl.innerText = "‚û°Ô∏è";
            }
        }

        async function saveOrderDetails() {
            if (!currentOrderId) return;
            toggleLoader(true);
            const nameParts = document.getElementById('input-name').value.trim().split(' ');
            const countryVal = document.getElementById('input-country').value;
            const addressVal = document.getElementById('input-address').value.trim();

            let meta = [];
            const allMetaKeys = [...ARRIVAL_FIELDS.map(f => f.key), ...DEPARTURE_FIELDS.map(f => f.key), ...ASSIGN_KEYS];
            allMetaKeys.forEach(k => {
                const inp = document.getElementById(`input-meta-${k}`);
                if (inp) meta.push({ key: k, value: inp.value });
            });

            const payload = {
                status: document.getElementById('input-status').value,
                billing: {
                    first_name: nameParts[0] || "", last_name: nameParts.slice(1).join(' ') || "",
                    email: document.getElementById('input-email').value.trim().toLowerCase(),
                    phone: document.getElementById('input-phone').value.trim(),
                    country: countryVal,
                    address_1: addressVal
                },
                shipping: {
                    first_name: nameParts[0] || "", last_name: nameParts.slice(1).join(' ') || "",
                    address_1: addressVal,
                    city: "",
                    country: countryVal
                },
                meta_data: meta
            };

            try {
                const resp = await fetch(`${API_PROXY}?order_id=${currentOrderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) throw new Error("Error");
                const updated = await resp.json();
                const idx = currentOrders.findIndex(o => o.id === currentOrderId);
                if (idx !== -1) currentOrders[idx] = updated;
                viewOrder(currentOrderId);
                updateStats();
            } catch (e) { console.error(e); } finally { toggleLoader(false); }
        }

        function togglePassengerEdit() {
            editingSections.passenger = !editingSections.passenger;
            const btn = document.getElementById('btn-edit-passenger');
            btn.innerText = editingSections.passenger ? "Cancelar" : "Editar";
            btn.classList.toggle('editing', editingSections.passenger);
            PASSENGER_EDIT_KEYS.forEach(k => {
                document.getElementById(`display-${k}`)?.classList.toggle('hidden', editingSections.passenger);
                document.getElementById(`input-${k}`)?.classList.toggle('hidden', !editingSections.passenger);
                if (!editingSections.passenger) document.getElementById(`input-${k}`).value = originalValues[k];
            });
            checkForChanges();
        }

        function toggleArrivalEdit() {
            editingSections.arrival = !editingSections.arrival;
            const btn = document.getElementById('btn-edit-arrival');
            btn.innerText = editingSections.arrival ? "Cancelar" : "Editar";
            btn.classList.toggle('editing', editingSections.arrival);

            const keys = ARRIVAL_FIELDS.map(f => f.key);
            keys.forEach(k => {
                document.getElementById(`display-meta-${k}`)?.classList.toggle('hidden', editingSections.arrival);
                document.getElementById(`input-meta-${k}`)?.classList.toggle('hidden', !editingSections.arrival);
            });
            checkForChanges();
        }

        function toggleDepartureEdit() {
            editingSections.departure = !editingSections.departure;
            const btn = document.getElementById('btn-edit-departure');
            btn.innerText = editingSections.departure ? "Cancelar" : "Editar";
            btn.classList.toggle('editing', editingSections.departure);

            const keys = DEPARTURE_FIELDS.map(f => f.key);
            keys.forEach(k => {
                document.getElementById(`display-meta-${k}`)?.classList.toggle('hidden', editingSections.departure);
                document.getElementById(`input-meta-${k}`)?.classList.toggle('hidden', !editingSections.departure);
            });
            checkForChanges();
        }

        function toggleStatusEditQuick() {
            document.getElementById('status-display-container').classList.add('hidden');
            document.getElementById('status-edit-container').classList.remove('hidden');
            document.getElementById('input-status').focus();
        }

        function checkForChanges() {
            let changed = false;
            PASSENGER_EDIT_KEYS.forEach(k => { if (document.getElementById(`input-${k}`)?.value.trim() !== originalValues[k]) changed = true; });
            if (document.getElementById('input-status').value !== originalValues.status) changed = true;

            const allMetaKeys = [...ARRIVAL_FIELDS.map(f => f.key), ...DEPARTURE_FIELDS.map(f => f.key), ...ASSIGN_KEYS];
            for (const k of allMetaKeys) {
                const inp = document.getElementById(`input-meta-${k}`);
                if (inp) {
                    const original = originalValues[k] || "";
                    let val = inp.value;
                    if (val !== original && val !== normalizeForInput(original, 'date') && val !== normalizeForInput(original, 'time')) {
                        changed = true;
                        break;
                    }
                }
            }
            document.getElementById('btn-save').classList.toggle('hidden', !changed);
        }

        function renderPaymentInfo(o) {
            const container = document.getElementById('payment-breakdown-list');
            container.innerHTML = '';

            const addRow = (label, value, isBold = false, isAccent = false, isDiscount = false) => {
                const numVal = parseFloat(value);
                if (value === undefined || value === null || value === "" || isNaN(numVal) || numVal === 0) return;
                const formattedValue = isDiscount ? `-$${Math.abs(numVal).toFixed(2)}` : `$${numVal.toFixed(2)}`;
                const colorClass = isDiscount ? 'text-green-600' : (isAccent ? 'text-red-500' : 'text-[#002a3f]');
                container.innerHTML += `
                    <div class="flex justify-between items-center ${isBold ? 'pt-3 border-t border-dashed border-gray-200 mt-2' : 'text-sm'}">
                        <span class="font-bold uppercase opacity-50 text-[10px] tracking-widest">${label}</span>
                        <span class="font-bold ${isBold ? 'text-2xl' : 'text-base'} ${colorClass}">${formattedValue}</span>
                    </div>`;
            };

            if (o.payment_method_title) {
                container.innerHTML += `<div class="text-[10px] uppercase font-black text-gray-400 mb-4 border-b pb-2">M√©todo: ${o.payment_method_title}</div>`;
            }

            const subtotal = (o.line_items || []).reduce((acc, item) => acc + parseFloat(item.subtotal || 0), 0);
            addRow("Subtotal Servicios", subtotal);

            if (o.fee_lines && o.fee_lines.length > 0) {
                o.fee_lines.forEach(fee => addRow(fee.name || 'Cargo Adicional', fee.total));
            }

            if (o.tax_lines && o.tax_lines.length > 0) {
                o.tax_lines.forEach(tax => addRow(tax.label || 'Impuesto', tax.tax_total));
            }

            if (o.coupon_lines && o.coupon_lines.length > 0) {
                o.coupon_lines.forEach(coupon => addRow(`Cup√≥n: ${coupon.code}`, coupon.discount, false, false, true));
            }
            addRow("Total Pagado", o.total, true);
        }

        function closeModal() { document.getElementById('order-modal').classList.add('hidden'); document.body.style.overflow = ''; }

        function deepScanMeta(o, k) {
            const clean = (s) => s.toLowerCase().replace(/[^a-z0-9]/g, '');
            const t = clean(k);
            let m = o.meta_data.find(x => clean(x.key) === t || clean(x.label || '') === t);
            if (!m && o.line_items?.[0]) m = o.line_items[0].meta_data.find(x => clean(x.key) === t || clean(x.display_key || '') === t);
            return m ? m.value : null;
        }

        function resolveAddress(o) { return (o.shipping?.address_1 || o.billing?.address_1 || "") + (o.shipping?.city ? ', ' + o.shipping.city : ''); }
        function resolveName(o) { const n = `${o.billing?.first_name || ''} ${o.billing?.last_name || ''}`.trim(); return n.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ') || `Reserva #${o.id}`; }
        function translateStatus(s) { const map = { 'pending': 'Pendiente', 'processing': 'Procesando', 'on-hold': 'Espera', 'completed': 'Completado', 'cancelled': 'Cancelado', 'failed': 'Fallido' }; return map[s] || s; }

        function translateTripType(o, raw) {
            if (!raw) return 'No especificado';
            if (raw.toLowerCase().includes('round')) return 'Ida y Vuelta';
            return deepScanMeta(o, "- Arrival Date") ? 'Solo ida al Hotel' : 'Solo ida al Aeropuerto';
        }

        function updatePaginationUI() {
            document.getElementById('pagination-info').innerText = `${totalOrders} Reservas encontradas`;
            let h = '';
            if (totalPages > 1) {
                if (currentPage > 1) h += `<button onclick="goToPage(${currentPage - 1})" class="px-4 h-10 rounded-md bg-white border">Ant.</button>`;
                for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) h += `<button onclick="goToPage(${i})" class="w-10 h-10 rounded-md ${i === currentPage ? 'bg-[#002a3f] text-white' : 'bg-white border'}">${i}</button>`;
                if (currentPage < totalPages) h += `<button onclick="goToPage(${currentPage + 1})" class="px-4 h-10 rounded-md bg-white border">Sig.</button>`;
            }
            document.getElementById('pagination-controls').innerHTML = h;
        }
        function toggleLoader(show) {
            const statusBar = document.getElementById('indexing-status');
            const apiBadge = document.getElementById('api-status-badge');
            const apiDot = document.getElementById('api-dot');
            const apiLabel = apiBadge ? apiBadge.querySelector('span:last-child') : null;

            // Ocultar el chip flotante para usar el badge como indicador
            if (statusBar) statusBar.style.display = 'none';
            if (!apiBadge || !apiDot || !apiLabel) return;

            if (show) {
                apiBadge.style.display = 'flex';
                apiDot.className = 'w-2 h-2 border-2 border-white/40 border-t-white rounded-full animate-spin mr-2';
                apiLabel.textContent = 'Indexando...';
            } else {
                apiDot.className = 'w-2 h-2 bg-green-400 rounded-full mr-2';
                apiLabel.textContent = 'Online';
            }
        }
        function setAPIStatus(s) {
            // Como el men√∫ controla el estado visual, podemos enviar un evento personalizado si lo deseamos,
            // pero por simplicidad en este paso, la funci√≥n queda vac√≠a ya que el elemento #api-dot y #api-status-badge
            // ahora viven dentro del Shadow DOM o template del men√∫ y no son accesibles directamente por ID desde aqu√≠
            // a menos que modifiquemos menu.js para exponer un m√©todo p√∫blico.

            // FIX: Para mantener la funcionalidad visual del punto verde/rojo,
            // vamos a intentar acceder al componente.
            const navbar = document.querySelector('admin-navbar');
            if (navbar) {
                const badge = navbar.querySelector('#api-status-badge');
                const dot = navbar.querySelector('#api-dot'); // Esto no funcionar√° si no est√°n en el DOM principal
                // Dado que menu.js inyecta el HTML directamente (no shadow DOM), s√≠ podemos acceder a ellos si el componente ya se renderiz√≥.

                const dotEl = document.getElementById('api-dot');
                const badgeEl = document.getElementById('api-status-badge');

                if (dotEl && badgeEl) {
                    dotEl.className = `w-2 h-2 rounded-full mr-2 ${s === 'online' ? 'bg-green-400' : 'bg-red-500'}`;
                    badgeEl.classList.remove('hidden');
                }
            }
        }
        function handleEmailInput() { const i = document.getElementById('input-email'); i.value = i.value.toLowerCase(); checkForChanges(); }
        function handleSearchInput() {
            document.getElementById('btn-clear-search').classList.toggle('hidden', document.getElementById('search-input').value === "");
            currentPage = 1;
            applyFilters();
        }
        function clearSearch() {
            document.getElementById('search-input').value = "";
            document.getElementById('btn-clear-search').classList.add('hidden');
            currentPage = 1;
            applyFilters();
        }
    </script>
</body>

</html>